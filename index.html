<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f97316">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sa√≠da Velozz">
    
    <title>Sa√≠da Flex Velozz</title>
    <link rel="manifest" href="manifest.json">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono&family=Barlow+Condensed:wght@400;700;900&display=swap');
        :root{ --bg:#0d0f12; --surface:#161a1f; --accent:#f97316; --text:#e8eaf0; --danger:#ef4444; --success:#22c55e; }
        *{box-sizing:border-box; margin:0; padding:0}
        body{font-family:'Barlow Condensed',sans-serif; background:var(--bg); color:var(--text); height:100vh; overflow:hidden; display:flex; flex-direction:column;}
        
        .overlay{position:fixed; inset:0; background:var(--bg); z-index:1000; padding:20px; display:flex; flex-direction:column; overflow-y:auto;}
        .hidden{display:none !important;}
        
        .card{background:var(--surface); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid #2a3040;}
        .btn{padding:15px; border-radius:8px; border:none; font-weight:900; text-transform:uppercase; cursor:pointer; width:100%; font-size:16px;}
        .btn-pr{background:var(--accent); color:#000;}
        .btn-sec{background:#2a3040; color:var(--text); margin-top:10px;}
        .btn-wa{background:#25D366; color:#fff; margin-bottom: 10px;}
        .btn-danger{background:var(--danger); color:#fff; padding:10px; font-size:14px; margin-top:10px;}
        .btn-warn{background:#eab308; color:#000; margin-bottom:15px; animation: pulse 1.5s infinite;}
        
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.02);} 100% {transform: scale(1);} }
        
        input, select{width:100%; background:#1e2430; border:1px solid #2a3040; padding:12px; color:#fff; border-radius:8px; font-size:18px; margin-bottom:10px; outline:none;}
        input:focus, select:focus{border-color:var(--accent);}
        
        .selfie-box{width:120px; height:120px; border:3px solid var(--accent); border-radius:60px; margin:0 auto 15px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#000; cursor:pointer;}
        .selfie-box img{width:100%; height:100%; object-fit:cover;}

        .tabs-header { display:flex; background:var(--surface); border-bottom:2px solid #2a3040; margin-bottom:10px; flex-shrink:0; overflow-x:auto; }
        .tab-link { flex:1; text-align:center; padding:12px 5px; color:#6b7280; font-weight:bold; font-size:14px; border-bottom:2px solid transparent; transition:0.3s; cursor:pointer; white-space:nowrap; min-width:80px;}
        .tab-link.active { color:var(--accent); border-bottom-color:var(--accent); }
        #swipeContainer { flex-grow:1; position:relative; overflow:hidden; display:flex; flex-direction:column; }
        .page { display:none; flex-direction:column; height:100%; overflow-y:auto; padding-bottom:15px; animation:fadeIn 0.2s ease-in-out; }
        .page.active { display:flex; }
        @keyframes fadeIn { from{opacity:0; transform:translateX(10px);} to{opacity:1; transform:translateX(0);} }

        .cam-container{position:relative; width:100%; min-height:250px; flex-grow:1; background:#000; border-radius:12px; overflow:hidden; margin-bottom:10px;}
        #camVideo{width:100%; height:100%; object-fit:cover;}
        .scanner-laser{position:absolute; top:50%; left:10%; right:10%; height:2px; background:var(--accent); box-shadow:0 0 15px var(--accent); animation: scan 2s infinite;}
        .btn-flash{position:absolute; bottom:15px; right:15px; width:45px; height:45px; border-radius:50%; background:rgba(0,0,0,0.6); border:2px solid #fff; color:#fff; font-size:20px; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:10;}
        @keyframes scan { 0%,100%{top:20%} 50%{top:80%} }
        
        .scan-flash{position:absolute;inset:0;pointer-events:none;z-index:10;opacity:0}
        .scan-flash.ok{animation:fGreen .3s ease}
        .scan-flash.dup{animation:fOrange .3s ease}
        @keyframes fGreen{0%{background:rgba(34,197,94,.55);opacity:1}100%{opacity:0}}
        @keyframes fOrange{0%{background:rgba(249,115,22,.45);opacity:1}100%{opacity:0}}

        .beep-ind{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);width:85px;height:85px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:38px;pointer-events:none;z-index:999;color:#000;}
        .beep-ind.show{animation:beepPop .45s ease forwards}
        @keyframes beepPop{0%{transform:translate(-50%,-50%) scale(0);opacity:1}40%{transform:translate(-50%,-50%) scale(1.25);opacity:1}100%{transform:translate(-50%,-50%) scale(1.6);opacity:0}}
        .beep-ml{background:rgba(255,230,0,.9)}.beep-shopee{background:rgba(238,77,45,.9)}.beep-avulso{background:rgba(148,163,184,.85)}

        .stats-grid{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-bottom:15px;}
        .stat-item{text-align:center; padding:10px; border-radius:8px; background:#1e2430; transition: transform 0.2s ease;}
        .stat-item.bump{transform: scale(1.1);}
        .stat-item.ml{border-top:4px solid #ffe600;}
        .stat-item.shopee{border-top:4px solid #ee4d2d;}
        .stat-item.avulso{border-top:4px solid #94a3b8;}
        
        .history-list{flex-grow:1; overflow-y:auto; font-family:'Space Mono', monospace; font-size:12px; margin-bottom:15px;}
        .hist-item{background:#1e2430; padding:8px; border-radius:6px; margin-bottom:5px; border-left:3px solid var(--accent); display:flex; justify-content:space-between; align-items:center; animation: slideIn 0.2s ease;}
        @keyframes slideIn{from{opacity:0; transform:translateY(-5px)}to{opacity:1; transform:translateY(0)}}
        .hist-del{background:none; border:none; color:var(--danger); font-size:16px; font-weight:bold; cursor:pointer; padding:0 5px;}

        .photos-grid{display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-bottom:15px;}
        .photo-slot{aspect-ratio:1; border-radius:8px; border:2px dashed #2a3040; display:flex; align-items:center; justify-content:center; color:#6b7280; font-size:24px; cursor:pointer; position:relative; overflow:hidden;}
        .photo-slot.live{border-color:var(--accent); color:var(--accent);}
        .photo-slot img{width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0;}
        .photo-del{position:absolute; top:2px; right:2px; background:rgba(0,0,0,0.7); color:#fff; border:none; border-radius:50%; width:22px; height:22px; font-size:12px; cursor:pointer;}

        .summary-box{background:#1e2430; padding:15px; border-radius:8px; font-family:'Space Mono'; font-size:13px; white-space:pre-wrap; margin-bottom:15px; border:1px solid #2a3040;}
    </style>
</head>
<body>

<script>
    const APP_CONFIG = {
        operadores: ["Ana Paula", "Bruno Silva", "Carlos Eduardo", "Fernanda Lima"],
        entregadores: ["Jo√£o Paulo", "Marcos Santos", "Lucas Oliveira", "Rafael Costa", "Motorista Avulso"]
    };
</script>

<div id="loginOverlay" class="overlay">
    <h2 style="text-align:center; color:var(--accent); margin-bottom:20px;">SA√çDA FLEX VELOZZ</h2>
    
    <button id="btnRecover" class="btn btn-warn hidden" onclick="app.session.recoverCrash()">‚ö†Ô∏è RECUPERAR FOTOS DA √öLTIMA SESS√ÉO</button>

    <div class="card">
        <div class="selfie-box" onclick="document.getElementById('inputSelfie').click()">
            <img id="previewSelfie" src="" style="display:none">
            <span id="selfiePlaceholder" style="font-size:12px; font-weight:bold;">üì∏ TIRAR SELFIE*</span>
        </div>
        <input type="file" id="inputSelfie" accept="image/*" capture="user" class="hidden">
        
        <label style="font-size:12px; color:#6b7280; text-transform:uppercase;">Operador:</label>
        <select id="selOperator"></select>

        <label style="font-size:12px; color:#6b7280; text-transform:uppercase;">Entregador:</label>
        <select id="selDriver"></select>

        <div style="text-align:center; margin-top:5px; font-size:11px; color:#6b7280;">
            *A lista √© gerenciada pela coordena√ß√£o.
        </div>

        <button class="btn btn-pr" id="btnStart" style="margin-top:15px" onclick="app.session.start()">‚ñ∂ INICIAR CONFER√äNCIA</button>
    </div>
</div>

<div id="mainApp" class="hidden" style="height:100vh; display:flex; flex-direction:column;">
    
    <div class="tabs-header">
        <div class="tab-link active" onclick="app.ui.goToTab(0)">üì∑ Scanner</div>
        <div class="tab-link" onclick="app.ui.goToTab(1)">üìã Hist√≥rico</div>
        <div class="tab-link" onclick="app.ui.goToTab(2)">üñºÔ∏è Fotos</div>
        <div class="tab-link" onclick="app.ui.goToTab(3)">üì§ Exportar</div>
    </div>

    <div id="swipeContainer" style="padding:0 10px;">
        
        <div class="page active" id="page-0">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:10px; margin-bottom:10px;">
                <div>
                    <h3 id="displayDriver" style="color:var(--accent); margin:0;">Entregador</h3>
                    <small id="displayOperator" style="color:#6b7280; font-family:'Space Mono';">Operador</small>
                </div>
                <button class="btn" style="width:auto; padding:5px 15px; background:var(--surface); border:1px solid var(--danger); color:var(--danger);" onclick="app.session.reset(true)">CANCELAR</button>
            </div>

            <div class="stats-grid">
                <div class="stat-item ml" id="box-ml">ML<br><b id="countML" style="font-size:22px; color:#ffe600;">0</b></div>
                <div class="stat-item shopee" id="box-shopee">SHOPEE<br><b id="countShopee" style="font-size:22px; color:#ee4d2d;">0</b></div>
                <div class="stat-item avulso" id="box-avulso">AVULSO<br><b id="countAvulso" style="font-size:22px; color:#94a3b8;">0</b></div>
            </div>

            <div class="cam-container" id="camContainer">
                <video id="camVideo" autoplay playsinline muted></video>
                <div class="scanner-laser"></div>
                <div class="scan-flash" id="scanFlash"></div>
                <button class="btn-flash" id="btnFlash" onclick="app.scanner.toggleFlashlight()">üî¶</button>
                <canvas id="qrCanvas" class="hidden"></canvas>
            </div>
            <button class="btn btn-sec" style="margin-top:auto;" onclick="app.ui.nextTab()">PR√ìXIMO ‚ûî</button>
        </div>

        <div class="page" id="page-1">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="color:#6b7280; font-size:12px; text-transform:uppercase;">Pacotes Lidos (<span id="countTotal">0</span>)</h4>
                <button style="background:none; border:none; color:var(--danger); font-size:12px; cursor:pointer;" onclick="app.session.clearAll()">Limpar Tudo</button>
            </div>
            <div id="historyList" class="history-list"></div>
            <button class="btn btn-sec" style="margin-top:auto;" onclick="app.ui.nextTab()">PR√ìXIMO ‚ûî</button>
        </div>

        <div class="page" id="page-2">
            <h4 style="color:#6b7280; font-size:12px; text-transform:uppercase; margin-bottom:10px;">Documenta√ß√£o (<span id="photoCountText">0</span>/8)</h4>
            <div class="photos-grid" id="photosGrid"></div>
            <input type="file" id="inputPhoto" accept="image/*" capture="environment" multiple class="hidden">
            <button class="btn btn-sec" style="background:#2a3040; color:#fff;" onclick="document.getElementById('inputPhoto').click()">üì∏ ADICIONAR FOTO</button>
            <button class="btn btn-danger hidden" id="btnClearPhotos" onclick="app.session.clearPhotos()">üóëÔ∏è REMOVER FOTOS</button>
            <button class="btn btn-sec" style="margin-top:auto;" onclick="app.ui.nextTab()">PR√ìXIMO ‚ûî</button>
        </div>

        <div class="page" id="page-3">
            <h4 style="color:#6b7280; font-size:12px; text-transform:uppercase; margin-bottom:10px;">Resumo da Sess√£o</h4>
            <div id="exportSummary" class="summary-box">Nenhum dado ainda.</div>
            <div style="margin-top:auto;">
                <button class="btn btn-wa" onclick="app.export.toWhatsApp()">üì≤ COMPARTILHAR E FINALIZAR</button>
                <button class="btn btn-pr" id="btnSheets" style="margin-top:0;" onclick="app.export.toSheets()">üìä ENVIAR PARA PLANILHA</button>
                <button class="btn btn-sec hidden" id="btnSync" style="background:#2a3040; color:var(--accent); border:1px solid var(--accent);" onclick="app.export.syncQueue()">üîÑ SINCRONIZAR PENDENTES (0)</button>
            </div>
        </div>

    </div>
</div>

<div class="beep-ind" id="beepEl"></div>
<canvas id="collageCanvas" style="display:none"></canvas>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
class UIController {
    constructor() {
        this.currentTab = 0;
        this.totalTabs = 4;
        this.bindSwipe();
    }
    goToTab(index) {
        if(index < 0 || index >= this.totalTabs) return;
        this.currentTab = index;
        document.querySelectorAll('.page').forEach((el, i) => { el.classList.toggle('active', i === index); });
        document.querySelectorAll('.tab-link').forEach((el, i) => { el.classList.toggle('active', i === index); });
        if(index === 3) document.getElementById('exportSummary').textContent = app.export.getSummary();
    }
    nextTab() { this.goToTab(this.currentTab + 1); }
    prevTab() { this.goToTab(this.currentTab - 1); }
    bindSwipe() {
        let touchstartX = 0; let touchendX = 0;
        const container = document.getElementById('swipeContainer');
        container.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, {passive: true});
        container.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX;
            if (touchendX < touchstartX - 60) this.nextTab(); 
            if (touchendX > touchstartX + 60) this.prevTab(); 
        }, {passive: true});
    }
    renderPhotos() {
        const grid = document.getElementById('photosGrid');
        grid.innerHTML = '';
        const photos = app.session.photos;
        photos.forEach((src, i) => {
            const slot = document.createElement('div');
            slot.className = 'photo-slot';
            slot.innerHTML = `<img src="${src}"><button class="photo-del" onclick="event.stopPropagation(); app.session.removePhoto(${i})">X</button>`;
            grid.appendChild(slot);
        });
        for (let i = photos.length; i < 8; i++) {
            const slot = document.createElement('div');
            slot.className = 'photo-slot' + (i === photos.length ? ' live' : '');
            slot.textContent = i === photos.length ? '+' : '‚óã';
            if (i === photos.length) slot.onclick = () => document.getElementById('inputPhoto').click();
            grid.appendChild(slot);
        }
        document.getElementById('photoCountText').textContent = photos.length;
        document.getElementById('btnClearPhotos').classList.toggle('hidden', photos.length === 0);
    }
}

class Registry {
    constructor() { this.renderAll(); }
    renderAll() {
        this.populate('selOperator', APP_CONFIG.operadores);
        this.populate('selDriver', APP_CONFIG.entregadores);
    }
    populate(id, list) {
        const el = document.getElementById(id);
        el.innerHTML = '<option value="">Selecionar...</option>';
        list.sort().forEach(item => { el.innerHTML += `<option value="${item}">${item}</option>`; });
    }
}

class Session {
    constructor(parent) {
        this.parent = parent;
        this.operator = '';
        this.driver = '';
        this.selfie = '';
        this.photos = [];
        this.counts = { ml: 0, shopee: 0, avulso: 0, total: 0 };
        this.codesMap = new Map();
        this.checkCrash();
    }

    // COFRE OTIMIZADO: Salva apenas fotos e dados base
    saveBackup() {
        const backup = {
            operator: this.operator,
            driver: this.driver,
            selfie: this.selfie,
            photos: this.photos
        };
        localStorage.setItem('velozz_active_session', JSON.stringify(backup));
    }

    checkCrash() {
        const backup = localStorage.getItem('velozz_active_session');
        if (backup) {
            document.getElementById('btnRecover').classList.remove('hidden');
        }
    }

    recoverCrash() {
        try {
            const backup = JSON.parse(localStorage.getItem('velozz_active_session'));
            this.operator = backup.operator;
            this.driver = backup.driver;
            this.selfie = backup.selfie;
            this.photos = backup.photos || [];
            
            // Inicia contagens e mapa limpos (sem os c√≥digos anteriores)
            this.counts = { ml: 0, shopee: 0, avulso: 0, total: 0 };
            this.codesMap = new Map();
            
            document.getElementById('selOperator').value = this.operator;
            document.getElementById('selDriver').value = this.driver;
            
            if(this.selfie) {
                document.getElementById('previewSelfie').src = this.selfie;
                document.getElementById('previewSelfie').style.display = 'block';
                document.getElementById('selfiePlaceholder').style.display = 'none';
            }

            document.getElementById('btnRecover').classList.add('hidden');
            this.start();
        } catch(e) {
            alert("Erro ao recuperar sess√£o.");
            localStorage.removeItem('velozz_active_session');
            document.getElementById('btnRecover').classList.add('hidden');
        }
    }

    start() {
        this.operator = document.getElementById('selOperator').value;
        this.driver = document.getElementById('selDriver').value;
        if(!this.selfie && this.photos.length === 0) return alert("A Selfie √© obrigat√≥ria!");
        if(!this.operator || !this.driver) return alert("Selecione Operador e Entregador!");

        this.parent.audio.init(); 
        this.saveBackup(); 

        document.getElementById('displayOperator').textContent = `Op: ${this.operator}`;
        document.getElementById('displayDriver').textContent = this.driver;
        document.getElementById('loginOverlay').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        
        this.parent.ui.renderPhotos();
        this.parent.scanner.init();
    }

    reset(isCancel = false) {
        if(isCancel && !confirm("Tem certeza que deseja cancelar esta carga? Os dados ser√£o perdidos.")) return;
        
        localStorage.removeItem('velozz_active_session');

        this.counts = { ml: 0, shopee: 0, avulso: 0, total: 0 };
        this.codesMap.clear();
        this.photos = [];
        this.driver = '';
        document.getElementById('selDriver').value = ''; 
        
        this.updateUI();
        this.parent.ui.renderPhotos();
        
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginOverlay').classList.remove('hidden');
        this.parent.ui.goToTab(0);
        this.parent.scanner.stop();
        document.getElementById('btnRecover').classList.add('hidden');
    }
    
    registerPackage(rawCode) {
        const code = rawCode.trim();
        if(this.codesMap.has(code)) {
            this.parent.audio.playError();
            this.parent.scanner.flash('dup');
            return;
        }

        let type = 'avulso';
        let displayCode = code;
        
        if (code.includes('hash_code') || code.includes('sender_id')) {
            type = 'ml';
            try { displayCode = JSON.parse(code).hash_code || "ML_JSON"; } catch(e){}
        } else if (/^BR[A-Z0-9]{10,16}$/i.test(code) || code.toLowerCase().includes('shopee')) {
            type = 'shopee';
        }

        this.counts[type]++;
        this.counts.total++;
        this.codesMap.set(code, { display: displayCode, type: type });
        
        this.parent.audio.playSuccess();
        this.parent.scanner.flash('ok');
        this.parent.scanner.showBeepVisual(type);
        
        this.updateUI(type);
    }

    removePackage(code) {
        const item = this.codesMap.get(code);
        if(!item) return;
        this.counts[item.type]--;
        this.counts.total--;
        this.codesMap.delete(code);
        this.updateUI();
    }

    clearAll() {
        if(!confirm("Tem certeza que deseja apagar todas as leituras?")) return;
        this.counts = { ml: 0, shopee: 0, avulso: 0, total: 0 };
        this.codesMap.clear();
        this.updateUI();
    }

    addPhoto(b64) { if(this.photos.length < 8) { this.photos.push(b64); this.parent.ui.renderPhotos(); this.saveBackup(); } }
    removePhoto(index) { this.photos.splice(index, 1); this.parent.ui.renderPhotos(); this.saveBackup(); }
    clearPhotos() { if(confirm("Apagar todas as fotos?")) { this.photos = []; this.parent.ui.renderPhotos(); this.saveBackup(); } }

    updateUI(lastType = null) {
        document.getElementById('countML').textContent = this.counts.ml;
        document.getElementById('countShopee').textContent = this.counts.shopee;
        document.getElementById('countAvulso').textContent = this.counts.avulso;
        document.getElementById('countTotal').textContent = this.counts.total;

        if (lastType) {
            const box = document.getElementById('box-' + lastType);
            if (box) {
                box.classList.remove('bump'); void box.offsetWidth; box.classList.add('bump');
                setTimeout(() => box.classList.remove('bump'), 200);
            }
        }
        
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        Array.from(this.codesMap.entries()).reverse().forEach(([rawCode, data]) => {
            const log = document.createElement('div');
            log.className = 'hist-item';
            let color = data.type === 'ml' ? '#ffe600' : (data.type === 'shopee' ? '#ee4d2d' : '#94a3b8');
            log.innerHTML = `<div><span style="color:${color}; font-weight:bold;">[${data.type.toUpperCase()}]</span> ${data.display.substring(0,22)}...</div><button class="hist-del" onclick="app.session.removePackage('${rawCode}')">X</button>`;
            list.appendChild(log);
        });
    }
}

class Scanner {
    constructor(parent) {
        this.parent = parent;
        this.video = document.getElementById('camVideo');
        this.canvas = document.getElementById('qrCanvas');
        this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });
        this.scanning = false;
        this.track = null;
        this.torchOn = false;
    }
    
    async init() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 }, advanced: [{ focusMode: "continuous" }] } 
            });
            this.video.srcObject = stream;
            this.track = stream.getVideoTracks()[0];
            this.scanning = true;
            this.scan();
        } catch(e) { alert("Erro ao acessar a c√¢mera: " + e.message); }
    }

    stop() {
        this.scanning = false;
        if (this.track) { this.track.stop(); this.track = null; }
        if (this.video.srcObject) { this.video.srcObject.getTracks().forEach(t => t.stop()); this.video.srcObject = null; }
    }
    
    async toggleFlashlight() {
        if (!this.track) return;
        try {
            const capabilities = this.track.getCapabilities();
            if (!capabilities.torch) return alert("A Apple bloqueia a lanterna no Safari. Ilumine o ambiente.");
            this.torchOn = !this.torchOn;
            await this.track.applyConstraints({ advanced: [{ torch: this.torchOn }] });
            document.getElementById('btnFlash').style.background = this.torchOn ? '#ffe600' : 'rgba(0,0,0,0.6)';
            document.getElementById('btnFlash').style.color = this.torchOn ? '#000' : '#fff';
        } catch (e) { alert("Erro ao ativar lanterna."); }
    }

    flash(type) {
        const el = document.getElementById('scanFlash');
        el.className = 'scan-flash'; void el.offsetWidth; el.className = 'scan-flash ' + type;
    }

    showBeepVisual(type) {
        const el = document.getElementById('beepEl');
        el.className = 'beep-ind beep-' + type;
        el.textContent = type === 'ml' ? 'üü°' : (type === 'shopee' ? 'üî¥' : '‚ö™');
        void el.offsetWidth; el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 500);
    }
    
    scan() {
        if(!this.scanning) return;
        if(this.parent.ui.currentTab === 0 && this.video.readyState === this.video.HAVE_ENOUGH_DATA) {
            this.canvas.height = this.video.videoHeight;
            this.canvas.width = this.video.videoWidth;
            this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
            const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

            if (code && code.data) {
                this.parent.session.registerPackage(code.data);
                setTimeout(() => requestAnimationFrame(() => this.scan()), 1500); 
                return;
            }
        }
        requestAnimationFrame(() => this.scan());
    }
}

class CollageBuilder {
    async build(session) {
        const sources = [];
        if (session.selfie) sources.push({ src: session.selfie, label: 'üë§ ' + session.operator });
        session.photos.forEach((s,i) => sources.push({ src: s, label: 'Foto ' + (i+1) }));
        
        if (!sources.length) return null;
        const load = src => new Promise((res, rej) => {
            const img = new Image(); img.crossOrigin='anonymous'; img.onload=()=>res(img); img.onerror=rej; img.src=src;
        });
        const loaded = await Promise.allSettled(sources.map(s => load(s.src)));
        const imgs = loaded.map((r,i) => r.status==='fulfilled' ? { img: r.value, label: sources[i].label } : null).filter(Boolean);
        if (!imgs.length) return null;

        const COLS = Math.min(imgs.length, 3), ROWS = Math.ceil(imgs.length/COLS), CELL = 320, HDR = 90, PAD = 8;
        const W = COLS*CELL + (COLS+1)*PAD, H = HDR + ROWS*CELL + (ROWS+1)*PAD;
        
        const canvas = document.getElementById('collageCanvas');
        canvas.width = W; canvas.height = H;
        const ctx = canvas.getContext('2d');
        
        ctx.fillStyle='#0d0f12'; ctx.fillRect(0,0,W,H);
        ctx.fillStyle='#161a1f'; ctx.fillRect(0,0,W,HDR);
        ctx.fillStyle='#f97316'; ctx.fillRect(0,HDR-3,W,3);
        
        ctx.fillStyle='#f97316'; ctx.font='bold 22px monospace'; ctx.fillText('SA√çDA FLEX VELOZZ', PAD+8, 32);
        ctx.fillStyle='#e8eaf0'; ctx.font='15px monospace'; ctx.fillText(`${session.driver} | Op: ${session.operator}`, PAD+8, 54);
        
        const d = new Date();
        ctx.fillStyle='#6b7280'; ctx.font='12px monospace';
        ctx.fillText(`${d.toLocaleDateString('pt-BR')} ${d.toLocaleTimeString('pt-BR')} | Total: ${session.counts.total}`, PAD+8, 74);
        
        imgs.forEach(({img, label}, idx) => {
            const col = idx%COLS, row = Math.floor(idx/COLS), x = PAD+col*(CELL+PAD), y = HDR+PAD+row*(CELL+PAD);
            ctx.fillStyle='#1e2430'; ctx.fillRect(x,y,CELL,CELL);
            const ratio = Math.max(CELL/img.naturalWidth, CELL/img.naturalHeight);
            const dw = img.naturalWidth*ratio, dh = img.naturalHeight*ratio, dx = x+(CELL-dw)/2, dy = y+(CELL-dh)/2;
            ctx.save(); ctx.beginPath(); ctx.rect(x,y,CELL,CELL); ctx.clip();
            ctx.drawImage(img, dx, dy, dw, dh); ctx.restore();
            ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(x, y+CELL-28, CELL, 28);
            ctx.fillStyle='#fff'; ctx.font='bold 14px monospace'; ctx.fillText(label, x+8, y+CELL-10);
        });
        return new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.90));
    }
}

class AudioController {
    constructor() { this.ctx = null; this.unlocked = false; }
    
    init() {
        if (this.unlocked) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!this.ctx && AudioContext) this.ctx = new AudioContext();
        if (this.ctx) {
            if (this.ctx.state === 'suspended') this.ctx.resume();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain); gain.connect(this.ctx.destination);
            gain.gain.value = 0; 
            osc.start(this.ctx.currentTime); osc.stop(this.ctx.currentTime + 0.1);
            this.unlocked = true;
        }
    }

    playSuccess() { if(this.ctx){ this.beep(880, 0.1, 0.5); setTimeout(() => this.beep(1100, 0.1, 0.5), 100); } }
    playError() { if(this.ctx) this.beep(200, 0.4, 0.8); }
    
    beep(freq, duration, vol) {
        if(this.ctx.state === 'suspended') this.ctx.resume();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain); gain.connect(this.ctx.destination);
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
        osc.start(); osc.stop(this.ctx.currentTime + duration);
    }
}

class ExportController {
    constructor(parent) {
        this.parent = parent;
        this.sheetsUrl = "SUA_URL_DO_GOOGLE_APPS_SCRIPT_AQUI"; 
        this.updateSyncUI();
        window.addEventListener('online', () => this.syncQueue());
        setInterval(() => { let q = JSON.parse(localStorage.getItem('velozz_sync_queue')) || []; if(q.length > 0 && navigator.onLine) this.syncQueue(); }, 120000); 
    }

    getSummary() {
        const s = this.parent.session;
        return `üì¶ SA√çDA FLEX VELOZZ\n--------------------------\nOp: ${s.operator}\nEntregador: ${s.driver}\n--------------------------\nüü° ML: ${s.counts.ml}\nüî¥ Shopee: ${s.counts.shopee}\n‚ö™ Avulso: ${s.counts.avulso}\nTOTAL: ${s.counts.total} pacotes\nüì∏ Fotos: ${s.photos.length}`;
    }

    async toWhatsApp() {
        if(this.parent.session.counts.total === 0 && this.parent.session.photos.length === 0) return alert("Nada para exportar!");
        
        const summary = this.getSummary().replace(/üì¶/g, '*üì¶').replace(/TOTAL:/g, '*TOTAL:*');
        const btn = document.querySelector('.btn-wa');
        const oldText = btn.textContent;
        btn.textContent = '‚è≥ GERANDO IMAGEM...';
        btn.disabled = true;

        try {
            const blob = await this.parent.collage.build(this.parent.session);
            if (navigator.canShare && blob) {
                const file = new File([blob], 'saida_velozz.jpg', { type: 'image/jpeg' });
                if (navigator.canShare({ files: [file] })) {
                    await navigator.share({ title: 'Sa√≠da Velozz', text: summary, files: [file] });
                    this.parent.session.reset(); 
                    return; 
                }
            }
            const text = encodeURIComponent(summary);
            window.open(`https://api.whatsapp.com/send?text=${text}`);
            this.parent.session.reset(); 

        } catch(e) {
            if (e.name !== 'AbortError') { 
                alert("Navegador bloqueou a foto. Enviando s√≥ texto...");
                window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(summary)}`);
                this.parent.session.reset();
            }
        } finally {
            btn.textContent = oldText;
            btn.disabled = false;
        }
    }

    async toSheets() {
        if(this.parent.session.counts.total === 0) return alert("Nenhum pacote bipado!");
        if(this.sheetsUrl === "SUA_URL_DO_GOOGLE_APPS_SCRIPT_AQUI") return alert("Configure a URL do Sheets no c√≥digo fonte!");
        
        const btn = document.getElementById('btnSheets');
        btn.disabled = true; btn.textContent = "‚è≥ ENVIANDO...";

        const payload = {
            date: new Date().toLocaleDateString('pt-BR'), time: new Date().toLocaleTimeString('pt-BR'),
            operator: this.parent.session.operator, driver: this.parent.session.driver,
            ml: this.parent.session.counts.ml, shopee: this.parent.session.counts.shopee, avulso: this.parent.session.counts.avulso,
            total: this.parent.session.counts.total, codes: Array.from(this.parent.session.codesMap.keys()).join(" | ")
        };

        if (!navigator.onLine) {
            this.saveToQueue(payload);
            alert("‚ö†Ô∏è Sem internet! Salvo para envio autom√°tico.");
            this.parent.session.reset(); 
            btn.disabled = false; btn.textContent = "üìä ENVIAR PARA PLANILHA";
            return;
        }

        try {
            await fetch(this.sheetsUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            this.parent.session.reset(); 
        } catch (e) {
            this.saveToQueue(payload);
            alert("‚ö†Ô∏è Instabilidade na rede! Salvo na fila interna.");
            this.parent.session.reset();
        } finally {
            btn.disabled = false; btn.textContent = "üìä ENVIAR PARA PLANILHA";
        }
    }

    saveToQueue(payload) {
        let queue = JSON.parse(localStorage.getItem('velozz_sync_queue')) || [];
        queue.push(payload); localStorage.setItem('velozz_sync_queue', JSON.stringify(queue));
        this.updateSyncUI();
    }

    async syncQueue() {
        let queue = JSON.parse(localStorage.getItem('velozz_sync_queue')) || [];
        if (queue.length === 0 || !navigator.onLine) return;
        const btnSync = document.getElementById('btnSync'); btnSync.textContent = "‚è≥ SINCRONIZANDO...";
        let successfulIndices = [];
        for (let i = 0; i < queue.length; i++) {
            try { await fetch(this.sheetsUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(queue[i]) }); successfulIndices.push(i); } catch (e) {}
        }
        if (successfulIndices.length > 0) {
            queue = queue.filter((_, index) => !successfulIndices.includes(index));
            localStorage.setItem('velozz_sync_queue', JSON.stringify(queue));
            alert(`‚úÖ ${successfulIndices.length} pend√™ncia(s) sincronizada(s)!`);
        }
        this.updateSyncUI();
    }

    updateSyncUI() {
        let queue = JSON.parse(localStorage.getItem('velozz_sync_queue')) || [];
        const btnSync = document.getElementById('btnSync');
        if (queue.length > 0) { btnSync.classList.remove('hidden'); btnSync.textContent = `üîÑ SINCRONIZAR PENDENTES (${queue.length})`; } 
        else { btnSync.classList.add('hidden'); }
    }
}

const app = { ui: new UIController(), registry: new Registry(), session: null, scanner: null, collage: new CollageBuilder(), audio: new AudioController(), export: null };
app.session = new Session(app); app.scanner = new Scanner(app); app.export = new ExportController(app);

document.getElementById('inputSelfie').onchange = function(e) {
    if(!e.target.files.length) return;
    const reader = new FileReader();
    reader.onload = function(event) {
        app.session.selfie = event.target.result;
        document.getElementById('previewSelfie').src = event.target.result;
        document.getElementById('previewSelfie').style.display = 'block';
        document.getElementById('selfiePlaceholder').style.display = 'none';
        app.session.saveBackup(); 
    };
    reader.readAsDataURL(e.target.files[0]);
};

document.getElementById('inputPhoto').onchange = function(e) {
    Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(event) { app.session.addPhoto(event.target.result); };
        reader.readAsDataURL(file);
    });
};

if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('sw.js').catch(()=>{})); }
</script>
</body>
</html>